name: PulseBot Job Search

on:
  # Ejecutar cada 6 horas
  schedule:
    - cron: '0 */6 * * *'  # A las 00:00, 06:00, 12:00, 18:00 UTC
  
  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:
  
  # Ejecutar en push para testing
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'demo.py'
      - 'test_reputation.py'

jobs:
  search-jobs:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para mantener historial
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -m textblob.download_corpora
    
    - name: ðŸ“‚ Restore sent jobs history
      run: |
        # Si existe el archivo en el commit anterior, usarlo
        if [ -f "sent_jobs.json" ]; then
          echo "âœ… Historial de ofertas enviadas encontrado"
        else
          echo "ðŸ“ Creando nuevo historial"
          echo '{"sent_job_ids": []}' > sent_jobs.json
        fi
    
    - name: ðŸ¤– Run PulseBot
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ðŸš€ Iniciando bÃºsqueda de empleos..."
        python job_search.py
        echo "âœ… BÃºsqueda completada"
    
    - name: ðŸ’¾ Commit sent jobs history
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if [ -f "sent_jobs.json" ]; then
          git add sent_jobs.json
          
          # Solo hacer commit si hay cambios
          if git diff --staged --quiet; then
            echo "ðŸ“Š No hay nuevas ofertas enviadas"
          else
            git commit -m "ðŸ“Š Update: Registro de ofertas enviadas $(date +'%Y-%m-%d %H:%M UTC')"
            echo "âœ… Historial actualizado"
          fi
        fi
    
    - name: ðŸ“¤ Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: ðŸ“Š Job Summary
      if: always()
      run: |
        echo "## ðŸ¤– PulseBot Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- â° Execution Time: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "sent_jobs.json" ]; then
          TOTAL_SENT=$(python -c "import json; data=json.load(open('sent_jobs.json')); print(len(data.get('sent_job_ids', [])))")
          echo "- ðŸ“Š Total ofertas enviadas (histÃ³rico): $TOTAL_SENT" >> $GITHUB_STEP_SUMMARY
        fi
