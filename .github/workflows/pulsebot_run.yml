name: PulseBot Automated Job Search

on:
  # Ejecutar cada 8 horas
  schedule:
    - cron: '0 */8 * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub UI
  workflow_dispatch:

jobs:
  run-pulsebot:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Necesario para hacer commit y push
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Traer todo el historial para commits
      
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cachear dependencias para acelerar
      
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m textblob.download_corpora
      
      - name: üîç Run PulseBot
        env:
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python job_search.py
      
      - name: üíæ Commit and Push Database Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Agregar solo el archivo de base de datos
          git add processed_jobs.db
          
          # Hacer commit solo si hay cambios
          git diff --staged --quiet || git commit -m "ü§ñ Update processed_jobs.db - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          
          # Push con retry en caso de conflictos
          git pull --rebase origin main
          git push
        continue-on-error: false  # Fallar si no se puede guardar la DB
      
      - name: ‚úÖ Success Notification
        if: success()
        run: |
          echo "‚úÖ PulseBot executed successfully!"
          echo "üìä Database updated and pushed to repository"
      
      - name: ‚ùå Failure Notification
        if: failure()
        run: |
          echo "‚ùå PulseBot execution failed!"
          echo "Check logs above for details"
